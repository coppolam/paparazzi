<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<flight_plan alt="1.5" ground_alt="0" lat0="51.990634" lon0="4.376789"
	max_dist_from_home="8" name="Test flight plan Steven" security_height="0.4">
	<header>
		#include "autopilot.h"
		#include "subsystems/ahrs.h"
		#include "subsystems/electrical.h"
		#include "subsystems/datalink/datalink.h"
	</header>
	<waypoints>
		<waypoint height="0" name="HOME" x="0.0" y="0.0" />
		<waypoint name="CIRCLEWP" x="0.0" y="0.0"/>
		<waypoint height="2" name="CLIMB" x="1.2" y="-0.6" />
		<waypoint height="1.5" name="STDBY" x="-2" y="-2" />
		<waypoint name="HOVER" x="1.0" y="1.0"/>
		<waypoint name="TD" x="0.8" y="-1.7" />
		<waypoint name="t0" lat="51.9906059" lon="4.3767772" />
		<waypoint name="t1" lat="51.9906269" lon="4.3767829" />
		<waypoint name="t2" lat="51.9906216" lon="4.3768187" />
		<waypoint name="t3" lat="51.9906388" lon="4.3768251" />
		<waypoint name="t4" lat="51.9906637" lon="4.3768005" />
		<waypoint name="t5" lat="51.9906425" lon="4.3767879" />
		<waypoint name="t6" lat="51.9906470" lon="4.3767547" />
		<waypoint name="t7" lat="51.9906290" lon="4.3767502" />
		<waypoint lat="51.9906213" lon="4.3768628" name="_CZ1" />
		<waypoint lat="51.9905874" lon="4.3767766" name="_CZ2" />
		<waypoint lat="51.9906409" lon="4.3767226" name="_CZ3" />
		<waypoint lat="51.990667" lon="4.376806" name="_CZ4" />
		<waypoint lat="51.9906831" lon="4.3768073" name="_DZ1" />
		<waypoint lat="51.9906472" lon="4.3767093" name="_DZ2" />
		<waypoint lat="51.9905876" lon="4.3767679" name="_DZ3" />
		<waypoint lat="51.9906254" lon="4.3768677" name="_DZ4" />
	</waypoints>
	<sectors>
		<sector color="orange" name="DangerZone">
			<corner name="_DZ1" />
			<corner name="_DZ2" />
			<corner name="_DZ3" />
			<corner name="_DZ4" />
		</sector>
	</sectors>
	<variables>
		<variable var="selfradius" min="-6" max="6" step="0.1" init="-3.2"/>
		<variable var="selfheading" min="0" max="360" step="10" init="0.0" />
	</variables>
	<blocks>
		<block name="Wait GPS">
			<call_once fun="NavKillThrottle()" />
			<while cond="!GpsFixValid()" />
		</block>
		<block name="Geo init">
			<while cond="LessThan(NavBlockTime(), 5)" />
			<call_once fun="NavSetAltitudeReferenceHere()" />
		</block>
		<block name="Holding point">
			<call_once fun="NavKillThrottle()" />
			<attitude pitch="0" roll="0" throttle="0" vmode="throttle" />
		</block>
		<block name="HoverHere">
			<call_once fun="nav_set_heading_deg(selfheading)" />
			<call_once fun="NavSetWaypointHere(WP_HOVER)" />
			<stay wp="HOVER" />
		</block>
		<block name="Set_Heading">
		  <call_once fun="nav_set_heading_deg(selfheading)" />
		  <call_once fun="NavSetWaypointHere(WP_HOVER)" />
		  <deroute block="HoverHere"/>
		</block>
		<block name="Circle">
			<call_once fun="switchOnGPSandSendGPS()"/>
			<call_once fun="nav_set_heading_deg(selfheading)" />
			<while cond="TRUE">
				<circle wp="CIRCLEWP" radius="selfradius" />
			</while>
		</block>
		<block name="Circle_onboard">
			<call_once fun="switchOnGPSandSendONBOARD()"/>
			<call_once fun="nav_set_heading_deg(selfheading)" />
			<while cond="TRUE">
				<circle wp="CIRCLEWP" radius="selfradius" />
			</while>
		</block>
		<block name="Fly_Trajectory">
			<call_once fun="switchOnGPSandSendGPS()"/>
			<call_once fun="initialiseTrajectory()"/>
			<while cond="TRUE">
				<call_once fun="flyTrajectory()"/>
			</while>			
		</block>
		<block name="Fly_Trajectory_onboard">
			<call_once fun="switchOnGPSandSendONBOARD()"/>
			<call_once fun="initialiseTrajectory()"/>
			<while cond="TRUE">
				<call_once fun="flyTrajectory()"/>
			</while>			
		</block>
		<block name="land here" strip_button="land Here" strip_icon="land-right.png">
			<call_once fun="NavSetWaypointHere(WP_TD)" />
		</block>
		<block name="land">
			<go wp="TD" />
		</block>
		<block name="flare">
			<exception cond="NavDetectGround()" deroute="Holding point" />
			<exception cond="!nav_is_in_flight()" deroute="landed" />
			<call_once fun="NavStartDetectGround()" />
			<stay climb="nav_descend_vspeed" vmode="climb" wp="TD" />
		</block>
		<block name="landed">
			<call_once fun="NavKillThrottle()" />
			<attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle" />
		</block>
	</blocks>
</flight_plan>
